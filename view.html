<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- css 스타일 -->
    <!-- <link href=".css/style.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- 부트스트랩 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <title>Document</title>
</head>
<body>
    <div class="wrap">
        <h2 class="title">화면 구성</h2>
        <div class="container">
            <div class="row">
                <div class="col item item1">
                    <!-- <video src="https://www.youtube.com/embed/BBdC1rl5sKY" controls loop muted autoplay></video> -->
                    <!-- <video controls width="480" height="300"> -->
                        <!-- <source src="http://192.168.0.3/stream"> -->
                        <iframe width="560" height="315" src="http://192.168.0.3:81/stream" title="YouTube video player"
                            frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                    <!-- </video> -->
                </div>
                <div class="col item item2">영상</div>
                <div class="w-100"></div>
                <div class="col item item3">
                    <a href="/btn1"><button type="button" class="btn bnt1 btn-outline-dark">1</button></a>
                    <a href="/btn2"><button type="button" class="btn bnt2 btn-outline-dark">2</button></a>
                    <a href="/btn3"><button type="button" class="btn bnt3 btn-outline-dark">3</button></a>
                    <a href="/btn4"><button type="button" class="btn bnt4 btn-outline-dark">4</button></a>
                </div>
                <!-- 조이스틱 코드 -->
                <div class="col item item4">
                    <!-- <canvas id="joy" style="border:5px dashed #BDBDBD"></canvas> -->
                    <canvas id="joy"></canvas>
                    <script>
                        var joy = document.getElementById("joy");
                        joy.width = 200;
                        joy.height = 200;
                        joy.addEventListener("touchstart", down);
                        joy.addEventListener("touchmove", move);
                        joy.addEventListener("touchend", up);
                        joy.addEventListener("mousedown", down);
                        joy.addEventListener("mousemove", move);
                        joy.addEventListener("mouseup", up);
                        // 캔버스의 2d 컨텍스트를 얻을 수 있다.
                        var ctx = joy.getContext("2d");
                        ctx.lineWidth = 10;
                        clearBackground();
                        drawCircle(100, 100, 50, "rgb(255,000,051)");
                        var startX, startY, moveX, moveY;
                        var joyPos = joy.getBoundingClientRect();
                        var onTouch = false;
                        function down(event) {
                            try {
                                startX = Math.round(event.touches[0].clientX - joyPos.left);
                                startY = Math.round(event.touches[0].clientY - joyPos.top);
                            } catch {
                                startX = Math.round(event.clientX - joyPos.left);
                                startY = Math.round(event.clientY - joyPos.top);
                            }
                            onTouch = true;
                        }

                        var moveMax = 100;
                        var msgPrev = "t";
                        var msg = "t";
                        function move(event) {
                            if (onTouch) {
                                try {
                                    moveX = Math.round(event.touches[0].clientX - joyPos.left) - startX;
                                    moveY = Math.round(event.touches[0].clientY - joyPos.top) - startY;
                                } catch {
                                    moveX = Math.round(event.clientX - joyPos.left) - startX;
                                    moveY = Math.round(event.clientY - joyPos.top) - startY;
                                }

                                if (moveX > moveMax) moveX = moveMax;
                                else if (moveX < -moveMax) moveX = -moveMax;
                                if (moveY > moveMax) moveY = moveMax;
                                else if (moveY < -moveMax) moveY = -moveMax;

                                clearBackground();
                                drawCircle(100 + moveX, 100 + moveY, 50, "rgb(255,000,051)");

                                // if (moveX >= 40) msg = "d";
                                // else if (moveX <= -40) msg = "a";
                                // else if (moveY <= -40) msg = "w";
                                // else if (moveY >= 40) msg = "x";

                                if (moveX >= -10 && moveX <= 10 && moveY <= -10 && moveY > -40) msg = "w"; // 앞 
                                else if (moveX >= -10 && moveX <= 10 && moveY > 10 &&moveY <= 40) msg = "s"; // 뒤 
                                else if (-50 <= moveX && moveX < -35 && moveY > 20 && moveY <= 40) msg = "a"; // 대각선 아래 왼
                                else if (moveX > 20 && moveX <= 50 && moveY > 10 && moveY <= 60) msg = "d"; // 대간선 아래 오
                                else if (moveX >= -50 && moveX < -35 && moveY < -20 && moveY >= -40) msg = "q"; // 대간선 위 왼
                                else if (20 < moveX && moveX <= 50 && moveY >= -60 && moveY < -10) msg = "e"; // 대간선 위 오

                                // console.log('moveX:', moveX)
                                // console.log('moveY:', moveY)
                                

                                if (msg != msgPrev) {
                                    send(msg);
                                    msgPrev = msg;
                                }
                                console.log(msg)
                            }                            
                        }

                        function up() {
                            clearBackground();
                            drawCircle(100, 100, 50, "rgb(255,000,051)");
                            msg = "t";
                            msgPrev = "t";
                            onTouch = false;
                            send(msg);

                            // $.ajax({
                            //     method: "GET",
                            //     url: "http://127.0.0.1:9999/msg",
                            //     data: JSON.stringify({ "msg": msg }),
                            //     dataType: "json",
                            //     contentType: "application/json; charset=UTF-8",
                            //     success: function (data) {
                            //         console.log(data)
                            //     }
                            // });
                        }

                        function send(msg) {
                            // console.log(msg);

                            // var object = {msg:msg};
                            // // alert(JSON.stringify(object))
                            $.ajax({
                                type: "GET",
                                url: "/msg",
                                data: { msg: msg },
                                success: function (response) {
                                    // console.log(response)
                                }
                            })
                        }

                        function clearBackground() {
                            ctx.clearRect(0, 0, joy.width, joy.height);
                            ctx.beginPath();
                            ctx.strokeStyle = "rgb(153,000,051)";
                            ctx.arc(100, 100, 90, 0, 2 * Math.PI);
                            ctx.stroke();
                        }

                        function drawCircle(x, y, r, c) {
                            ctx.beginPath();
                            ctx.fillStyle = c;
                            ctx.arc(x, y, r, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                        
                    </script>

                </div>
            </div>
        </div>
        <!-- <div class="container">

            <div class="item item1">영상</div>
            <div class="item item2">영상</div>
            <div class="item item3">
                <button type="button" class="btn btn-outline-dark">Dark</button>
            </div>
            <div class="item item4">4</div>
        </div> -->
    </div>
</body>
</html>